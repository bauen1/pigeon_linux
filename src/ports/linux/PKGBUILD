# linux - provides the kernel and kernel modules
#
#

pkgbase=linux
_srcname=linux-4.8.9
pkgver=4.8.9
pkgrel=1
arch=('x86_64')
url="https://www.kernel.org/"
license=('GPL2')
makedepends=('xmlto' 'docbook-xsl' 'kmod' 'inetutils' 'bc' 'libelf')
options=('!strip')
source=("https://www.kernel.org/pub/linux/kernel/v4.x/${_srcname}.tar.xz"
#        "https://www.kernel.org/pub/linux/kernel/v4.x/${_srcname}.tar.sign"
        )

sha256sums=('SKIP'
#            'SKIP'
            )
#validpgpkeys=('ABAF11C65A2970B130ABE3C479BE3E4300411886' # Linus Torvalds
#              '647F28654894E3BD457199BE38DBBDC86092693E' # Greg Kroah-Hartman
#              )

_kernelname=${pkgname#linux}

prepare() {
  cd "${srcdir}/${_srcname}"
  make defconfig
  # enable the (generic) vesa framebuffer driver
  sed -i "s/.*CONFIG_FB_VESA.*/CONFIG_FB_VESA=y/" .config
}

build() {
  cd "${srcdir}/${_srcname}"

  make ${MAKEFLAGS} bzImage modules
}

_package() {
  pkgdesc="The ${pkgbase/linux/Linux} kernel and modules and firmware"
  cd "${srcdir}/${_srcname}"

  # get kernel version
  _kernver="$(make LOCALVERSION= kernelrelease)"
  _basekernel=${_kernver%%-*}
  _basekernel=${_basekernel%.*}

  mkdir -p "${pkgdir}"/{lib/modules,lib/firmware,boot}
  make ${MAKEFLAGS} INSTALL_MOD_PATH="${pkgdir}" modules_install
  cp arch/x86/boot/bzImage "${pkgdir}/boot/vmlinuz-${pkgbase}"

}

_package-headers() {
  pkgdesc="The ${pkgbase/linux/Linux} header files"
  cd "${srcdir}/${_srcname}"

  make ${MAKEFLAGS} INSTALL_HDR_PATH="$pkgdir/usr" headers_install
}

_package-docs() {
  pkgdesc="The ${pkgbase/linux/Linux} documentation"
  # TODO: implement
}

pkgname=("${pkgbase}" "${pkgbase}-headers" "${pkgbase}-docs")
for _p in ${pkgname[@]}; do
  eval "package_${_p}() {
    $(declare -f "_package${_p#${pkgbase}}")
    _package${_p#${pkgbase}}
  }"
done
